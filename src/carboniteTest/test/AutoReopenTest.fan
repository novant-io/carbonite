//
// Copyright (c) 2024, Andy Frank
// Licensed under the MIT License
//
// History:
//   8 Feb 2024  Andy Frank  Creation
//

using carbonite

*************************************************************************
** AutoReopenTest
*************************************************************************

class AutoReopenTest : AbstractStoreTest
{
  Void testBasics()
  {
    // first test close will fail
    eachImpl([Employees#]) |ds|
    {
      // create some data and verify
      CTable e := ds.table(Employees#)
      e.create(["id":1, "name":"Ron Burgundy",          "pos":"lead"])
      e.create(["id":2, "name":"Veronica Corningstone", "pos":"lead"])
      verifyEq(e.size, 2)
      verifyEq(e.listAll[0]->name, "Ron Burgundy")
      verifyEq(e.listAll[1]->name, "Veronica Corningstone")

      // close and verify fail
      ds.close
      verifySqlErr { x := ds.table(Employees#).size }
    }

    // then check autoreopen succeeds
    eachImplOpts([Employees#], ["auto_reopen":true]) |ds|
    {
      // create some data and verify
      CTable e := ds.table(Employees#)
      e.create(["id":3, "name":"Brian Fantana",    "pos":"sports"])
      verifyEq(e.size, 3)
      verifyEq(e.listAll[2]->name, "Brian Fantana")

      // close and verify auto-reopen
      ds.close
      verifyEq(ds.table(Employees#).size, 3)

      // close and verify auto-reopen
      ds.close
      e = ds.table(Employees#)
      e.create(["id":4, "name":"Brick Tamland", "pos":"weather"])
      verifyEq(e.size, 4)
      verifyEq(e.listAll[0]->name, "Ron Burgundy")
      verifyEq(e.listAll[1]->name, "Veronica Corningstone")
      verifyEq(e.listAll[2]->name, "Brian Fantana")
      verifyEq(e.listAll[3]->name, "Brick Tamland")
    }
  }
}